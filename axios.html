<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    input {
        width: 10rem;
        height: 1rem;
        display: block;
        margin: 1rem;
        font-size: 1rem;
        text-indent: 2rem;
        font-weight: 400;
    }

    button {
        width: 5rem;
        height: 2rem;
        display: block;
        margin: 1rem;
        border: none;
        background-color: cadetblue;
        color: white;
        font-size: 1rem;
        border-radius: 0.5rem;
        text-align: center;
    }

    main {
        width: 1200px;
        background-color: aqua;
        display: flex;
        justify-content: space-between;
    }

    main img {
        width: 100px;
        height: 100px;
        border: 1px #336699 solid;
        border-radius: 50%;
    }

    audio,
    input {
        outline: none;
    }

    ul,
    li {
        list-style: none;
    }
</style>

<body>

    <form action="https://music.hzbiz.net/login/cellphone" method="GET" id="login">
        <input type="text" name="phone" placeholder="phone" id="phone">
        <input type="password" name="password" id="pw" placeholder="pw">
        <button type="submit">提交</button>
    </form>

    <div class="qr"><button type="submit" id="qr">扫码登录</button></div>

    <main>
        <ul class="songList">

        </ul>
    </main>

    <script src="../jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        axios.defaults.baseURL = 'https://music.hzbiz.net/';
        axios.defaults.withCredentials = true;

        $('#qr').on('click', function (e) {

            // console.log(e);
            var url = 'login/qr/key?e=' + (new Date());
            var info = $(this).serializeArray();
            var params = {};

            // console.log('asd'+info);
            axios.post(url, params)
                .then(res => {
                    console.log(res.data.data.unikey);

                    // Create Qr Code
                    var url = 'login/qr/create?e=' + (new Date());
                    var params = {
                        key: res.data.data.unikey,
                        qrimg: 1
                    };

                    axios.post(url, params)
                        .then(res => {
                            console.log(res.data.data.qrimg)
                            var qr = $('<img src="' + res.data.data.qrimg + '">');
                            $('.qr').append(qr);

                        })
                        .catch(err => {
                            console.error(err);
                        })

                    // check QrScanning status
                    function checkStatus(res) {
                        var url = 'login/qr/check?e=' + (new Date());
                        var params = {
                            key: res.data.data.unikey
                        };

                        axios.post(url, params)
                            .then(res => {
                                console.log(res.data.code);
                                if (res.data.code == '803') {
                                    clearInterval(timeId);

                                    var url = 'login/refresh?e=' + (new Date());
                                    axios.post(url)
                                        .then(res => {
                                            console.log(res)
                                        })
                                        .catch(err => {
                                            console.error(err);
                                        })
                                }
                            })
                            .catch(err => {
                                console.error(err);
                            })
                    }

                    const timeId = setInterval(() => {
                        checkStatus(res);
                        // console.log('turn');
                    }, 1000);
                })
                .catch(err => {
                    console.error(err);
                })
                .catch(err => {
                    console.error(err);
                })
        })


        $('#login').on('submit', function (e) {
            e.preventDefault();
            var url = $(this).attr('action') + '?e=' + (+new Date());
            var info = $(this).serializeArray();
            var params = {
                phone: info[0].value,
                password: info[1].value
            }

            // console.log(params[0].value);
            axios.post(url, params)
                .then(res => {
                    console.log(res);
                    var avatar = $('<img src="' + res.data.profile.avatarUrl + '">')
                    $('main').append(avatar);

                    var songListUrl = 'user/playlist';
                    var uId = {
                        uid: res.data.profile.userId
                    };


                    axios.post(songListUrl, uId)
                        .then(res => {
                            console.log(res.data.playlist);

                            for (let index = 0; index < res.data.playlist.length; index++) {
                                var songList = $('<li>' + res.data.playlist[index].name + '</li>')
                                $('.songList').append(songList);
                            }

                            var url = 'playlist/detail';
                            var params = {
                                id: res.data.playlist[0].id
                            };
                            axios.post(url, params)
                                .then(res => {
                                    console.log(res.data.playlist.trackIds[0].id)
                                    var url = 'song/url';
                                    var params = {
                                        id: res.data.playlist.trackIds[30].id
                                    }

                                    axios.post(url, params)
                                        .then(res => {
                                            console.log(res);
                                            var player = $('<audio controls><source src = ' +
                                                res.data.data[0].url + '/></audio>')
                                            $('main').append(player);
                                        })
                                        .catch(err => {
                                            console.error(err);
                                        })
                                })
                                .catch(err => {
                                    console.error(err);
                                })
                        })
                        .catch(err => {
                            console.error(err);
                        })
                })
                .catch(err => {
                    console.error(err);
                })


        })
    </script>
</body>

</html>